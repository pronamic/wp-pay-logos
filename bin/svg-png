#!/usr/bin/env php
<?php

$iterator = new RecursiveDirectoryIterator( __DIR__ . '/../src/' );

$iterator = new RecursiveIteratorIterator( $iterator );

//$iterator = new RegexIterator( $iterator, '/^.+\.svg$/i', RecursiveRegexIterator::GET_MATCH );

foreach ( $iterator as $file ) {
	if ( 'svg' !== $file->getExtension() ) {
		continue;
	}
	
	echo $file->getRealPath(), PHP_EOL;

	$filename = $file->getFilename();

	echo $filename, PHP_EOL;

	$result = preg_match( '/-(?<width>\d*)x(?<height>\d*)./', $filename, $matches );

	if ( ! array_key_exists( 'width', $matches ) ) {
		continue;
	}

	if ( ! array_key_exists( 'height', $matches ) ) {
		continue;
	}

	$width  = $matches['width'];
	$height = $matches['height'];

	$info = new SplFileInfo( $file->getRealPath() );

	$densities = array(
		'1' => (object) array(
			'factor'    => 1,
			'extension' => '.png',
		),
		'2' => (object) array(
			'factor'    => 2,
			'extension' => '@2x.png',
		),
		'3' => (object) array(
			'factor'    => 3,
			'extension' => '@3x.png',
		),
		'4' => (object) array(
			'factor'    => 4,
			'extension' => '@4x.png',
		),
	);

	foreach ( $densities as $density ) {
		$png = $info->getPath() . '/' . $info->getBasename( '.' . $info->getExtension() ) . $density->extension;

		$w = $width * $density->factor;
		$h = $height * $density->factor;

		$command = sprintf(
			'inkscape --export-png=%s --export-width=%d --export-height=%d %s',
			$png,
			$w,
			$h,
			$file->getRealPath()
		);

		echo $command, PHP_EOL;

		passthru( $command );
	}
}
